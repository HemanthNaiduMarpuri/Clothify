{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container my-5">
  <h2 class="fw-bold mb-4">Confirm delivery details</h2>

  <div class="row g-4">
    <div class="col-md-7">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Items in your cart</h5>

        {% if cart_items %}
          {% for item in cart_items %}
            <div class="d-flex align-items-center mb-3">
              <img src="{{ item.product.product_image.url }}"
                   style="width:72px; height:72px; object-fit:cover; border-radius:8px;"
                   class="me-3">
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ item.product.product_name }}</div>
                <div class="text-muted">Qty: {{ item.quantity }}</div>
              </div>
              <div class="fw-bold">â‚¹{{ item.product.product_price }}</div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">Your cart is empty.</p>
        {% endif %}
      </div>
    </div>

    <div class="col-md-5">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-2">Delivery & contact</h5>

        <form method="post" id="checkout-form">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <div class="mb-2">
            {{ form.recipient_name.label_tag }}
            {{ form.recipient_name }}
            {{ form.recipient_name.errors }}
          </div>

          <div class="mb-2">
            {{ form.recipient_phone.label_tag }}
            {{ form.recipient_phone }}
            {{ form.recipient_phone.errors }}
          </div>

          <div class="mb-2">
            {{ form.address_text.label_tag }}
            {{ form.address_text }}
            {{ form.address_text.errors }}
          </div>

          {{ form.latitude }}
          {{ form.longitude }}

          <div class="d-flex gap-2 mb-3">
            <button type="button" id="use-location"
                    class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-geo-alt"></i> Use my current location
            </button>

            <button type="button" id="clear-location"
                    class="btn btn-outline-danger btn-sm">
              Clear
            </button>

            <small id="geo-status"
                   class="text-muted align-self-center ms-2">
              or type address manually
            </small>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              Proceed to Payment
            </button>
          </div>
        </form>

        <div class="mt-3">
          <small class="text-muted">
            This will not update your profile.
            To permanently change details, go to
            <a href="{% url 'customer_profile_edit' %}">Profile</a>.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function reverseGeocode(lat, lon) {
  const url =
    `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
  const resp = await fetch(url, { headers: { "Accept": "application/json" } });
  if (!resp.ok) throw new Error("Reverse geocode failed");
  return resp.json();
}

document.addEventListener("DOMContentLoaded", function () {
  const useBtn = document.getElementById("use-location");
  const clearBtn = document.getElementById("clear-location");
  const status = document.getElementById("geo-status");

  useBtn.addEventListener("click", function () {
    if (!navigator.geolocation) {
      status.textContent = "Geolocation not supported.";
      return;
    }

    status.textContent = "Fetching location...";

    navigator.geolocation.getCurrentPosition(async function (pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      try {
        const data = await reverseGeocode(lat, lon);
        document.querySelector(
          "textarea[name='address_text']"
        ).value = data.display_name || "";

        document.querySelector("input[name='latitude']").value = lat;
        document.querySelector("input[name='longitude']").value = lon;

        status.textContent =
          "Address filled. Verify and click Proceed to Payment.";
      } catch (e) {
        status.textContent = "Could not fetch address.";
      }
    }, function () {
      status.textContent =
        "Location denied. Please type address manually.";
    });
  });

  clearBtn.addEventListener("click", function () {
    document.querySelector("textarea[name='address_text']").value = "";
    document.querySelector("input[name='latitude']").value = "";
    document.querySelector("input[name='longitude']").value = "";
    status.textContent = "Cleared.";
  });
});
</script>

{% endblock %}
